<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Water Bill OCR â€” Combined View</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial;
       background:#f2f6fb;margin:0;padding:18px;max-width:860px;margin:auto;}
  header{background:linear-gradient(135deg,#4facfe,#00f2fe);color:white;padding:18px;border-radius:14px;}
  h1{margin:0;font-size:20px;}
  .card{background:white;padding:14px;margin-top:16px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.08);}
  .btn{padding:8px 12px;border:none;border-radius:8px;font-weight:600;font-size:14px;cursor:pointer;margin:4px;}
  .primary{background:#4facfe;color:white;}
  .secondary{background:#f9f9f9;color:#4facfe;border:1px solid #4facfe;}
  table{width:100%;border-collapse:collapse;font-size:14px;margin-top:10px;}
  th,td{padding:8px;border-bottom:1px solid #eee;word-break:break-word;text-align:center;}
  th{background:#fafafa;position:sticky;top:0;}
  tr:nth-child(even){background:#fcfcfc;}
  .diff-red{color:red;font-weight:bold;}
  .diff-green{color:green;font-weight:bold;}
  .diff-gray{color:gray;}
  img.thumb{width:64px;height:auto;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.08);}
  input.editable{border:1px solid #ccc;border-radius:4px;padding:4px;width:100%;box-sizing:border-box;}
  input.edited{background:#fff7c2;}
  #debug{display:none;margin-top:12px;}
  pre.log{white-space:pre-wrap;background:#fff;border-radius:8px;padding:8px;font-size:12px;color:#333;}
</style>
</head>
<body>
<header>
  <h1>ðŸ“„ Water Bill OCR (Combined View)</h1>
  <p>Step 1 + Step 2 merged with manual correction</p>
</header>

<div class="card">
  <h2>Step 1: Upload Previous Water Bill Excel</h2>
  <input type="file" id="prevExcel" accept=".xlsx,.xls" />
  <div id="prevStatus" style="margin-top:10px;color:#555"></div>
</div>

<div class="card">
  <h2 style="display:flex;justify-content:space-between;align-items:center;">
    Step 2: OCR New Water Bills
    <button id="toggleDebug" class="btn secondary">Show Debug</button>
  </h2>
  <div>
    <label class="btn secondary">Upload Photos
      <input type="file" id="fileInput" accept="image/*" multiple hidden>
    </label>
    <label class="btn secondary">Take Photo
      <input type="file" id="cameraInput" accept="image/*" capture="environment" hidden>
    </label>
    <button id="clearBtn" class="btn secondary">Clear</button>
    <button id="exportBtn" class="btn primary">Export to Excel</button>
  </div>
  <div id="status" style="margin-top:10px;color:#555"></div>
  <table>
    <thead><tr>
      <th>Preview</th><th>Name</th><th>Meter No. (Prev)</th><th>Prev Consumption</th>
      <th>Meter No. (OCR)</th><th>Current Consumption (OCR)</th><th>% Difference</th>
    </tr></thead>
    <tbody id="results"></tbody>
  </table>
  <div id="debug"><h3>Debug</h3><pre class="log" id="debugLog"></pre></div>
</div>

<script>
function cleanMeter(s){
  if(!s) return '';
  return s.toString().replace(/[^A-Z0-9\-]/ig,'').toUpperCase().trim();
}
function calcDiff(prev, curr){
  const pn = parseFloat(prev);
  const cn = parseFloat(curr);
  if(!isFinite(pn) || pn===0 || !isFinite(cn)) return {text:"â€”", cls:"diff-gray"};
  const diff = Math.abs(((cn - pn)/pn)*100);
  const rounded = (Math.round(diff*10)/10).toFixed(1) + "%";
  return diff > 30 ? {text:rounded, cls:"diff-red"} : {text:rounded, cls:"diff-green"};
}

let prevData = [];
let prevMap = {}, prevMapLast6 = {};
let ocrResults = [];

document.getElementById('prevExcel').addEventListener('change', e=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = evt=>{
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, {type:'array'});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet,{defval:""});
    prevData = json.map(r=>{
      let Name = r.Name || r.name || "";
      let Meter = r['Meter No.'] || r['meter no'] || r.Meter || "";
      let Cons = r.Consumption || r.consumption || "";
      let cleaned = cleanMeter(Meter);
      return {Name, Meter, CleanMeter: cleaned, Consumption: Cons};
    });
    prevMap = {}; prevMapLast6={};
    prevData.forEach(r=>{
      if(r.CleanMeter) prevMap[r.CleanMeter] = r;
      const last6 = r.CleanMeter.replace(/[^0-9]/g,'').slice(-6);
      if(last6) prevMapLast6[last6] = prevMapLast6[last6]||r;
    });
    document.getElementById('prevStatus').innerText="Loaded "+prevData.length+" records.";
    renderCombined();
  };
  reader.readAsArrayBuffer(file);
});

function addOCRRow(preview, meterOCR, consumptionOCR, rawText){
  ocrResults.push({preview, meterOCR, consumptionOCR, rawText});
  renderCombined();
}

function renderCombined(){
  const combined = [];
  prevData.forEach(r=>{
    const match = ocrResults.find(o=> cleanMeter(o.meterOCR)===r.CleanMeter ||
       cleanMeter(o.meterOCR).replace(/[^0-9]/g,'').slice(-6)===r.CleanMeter.replace(/[^0-9]/g,'').slice(-6));
    if(match){
      combined.push({
        preview: match.preview,
        name: r.Name, meterPrev: r.Meter, prevCons: r.Consumption,
        meterOCR: match.meterOCR, consumptionOCR: match.consumptionOCR,
        diffObj: calcDiff(r.Consumption, match.consumptionOCR),
        rawText: match.rawText
      });
    } else {
      combined.push({
        preview:"", name:r.Name, meterPrev:r.Meter, prevCons:r.Consumption,
        meterOCR:"Not Found", consumptionOCR:"Not Found",
        diffObj:{text:"â€”",cls:"diff-gray"}, rawText:""
      });
    }
  });
  ocrResults.forEach(match=>{
    const cleaned=cleanMeter(match.meterOCR);
    const found = prevData.find(r=> r.CleanMeter===cleaned ||
       cleaned.replace(/[^0-9]/g,'').slice(-6)===r.CleanMeter.replace(/[^0-9]/g,'').slice(-6));
    if(!found){
      combined.push({
        preview:match.preview, name:"Not Found", meterPrev:"Not Found", prevCons:"Not Found",
        meterOCR:match.meterOCR, consumptionOCR:match.consumptionOCR,
        diffObj:{text:"â€”",cls:"diff-gray"}, rawText:match.rawText
      });
    }
  });
  renderResults(combined);
}

const resultsTable=document.getElementById('results');
function renderResults(rows){
  resultsTable.innerHTML="";
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.preview?`<img class="thumb" src="${r.preview}" />`:""}</td>
      <td>${r.name||"Not Found"}</td>
      <td>${r.meterPrev||"Not Found"}</td>
      <td>${r.prevCons||"Not Found"}</td>
      <td><input class="editable" data-index="${i}" data-field="meterOCR" value="${r.meterOCR}"></td>
      <td><input class="editable" data-index="${i}" data-field="consumptionOCR" value="${r.consumptionOCR}"></td>
      <td class="${r.diffObj.cls}">${r.diffObj.text}</td>`;
    resultsTable.appendChild(tr);
  });
  attachEditHandlers(rows);
}

function attachEditHandlers(rows){
  document.querySelectorAll('input.editable').forEach(inp=>{
    inp.addEventListener('input', e=>{
      inp.classList.add('edited');
      const idx=parseInt(e.target.dataset.index);
      const field=e.target.dataset.field;
      rows[idx][field]=e.target.value;
      if(field==="meterOCR"){
        const cleaned=cleanMeter(e.target.value);
        const found=prevData.find(r=> r.CleanMeter===cleaned ||
          cleaned.replace(/[^0-9]/g,'').slice(-6)===r.CleanMeter.replace(/[^0-9]/g,'').slice(-6));
        if(found){
          rows[idx].name=found.Name; rows[idx].meterPrev=found.Meter; rows[idx].prevCons=found.Consumption;
          rows[idx].diffObj=calcDiff(found.Consumption, rows[idx].consumptionOCR);
        } else {
          rows[idx].name="Not Found"; rows[idx].meterPrev="Not Found"; rows[idx].prevCons="Not Found";
          rows[idx].diffObj={text:"â€”",cls:"diff-gray"};
        }
      }
      if(field==="consumptionOCR"){
        rows[idx].diffObj=calcDiff(rows[idx].prevCons, e.target.value);
      }
      renderResults(rows);
    });
  });
}

document.getElementById('clearBtn').addEventListener('click',()=>{ocrResults=[];renderCombined();});
document.getElementById('exportBtn').addEventListener('click',()=>{
  const rows=[];
  document.querySelectorAll('#results tr').forEach(tr=>{
    const cells=tr.querySelectorAll('td');
    rows.push({Name:cells[1].innerText,"Meter No.":cells[2].innerText,"Current Consumption":cells[5].querySelector('input').value});
  });
  const ws=XLSX.utils.json_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Results');
  XLSX.writeFile(wb,'bills_results.xlsx');
});
document.getElementById('toggleDebug').addEventListener('click',()=>{
  const dbg=document.getElementById('debug');
  if(dbg.style.display==='none'){dbg.style.display='block';document.getElementById('toggleDebug').innerText="Hide Debug";}
  else{dbg.style.display='none';document.getElementById('toggleDebug').innerText="Show Debug";}
});
</script>
</body>
</html>