<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Water Bill OCR â€” Camera + Upload</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
  body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial;
       background:#f2f6fb;margin:0;padding:18px;max-width:480px;margin:auto;}
  header{background:linear-gradient(135deg,#4facfe,#00f2fe);color:white;padding:18px;border-radius:14px;}
  h1{margin:0;font-size:20px;}
  .card{background:white;padding:12px;margin-top:12px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.08);}
  .btn{padding:10px 14px;border:none;border-radius:8px;font-weight:600;font-size:15px;cursor:pointer;}
  .primary{background:#4facfe;color:white;}
  .secondary{background:#f9f9f9;color:#4facfe;border:1px solid #4facfe;}
  table{width:100%;border-collapse:collapse;font-size:14px;margin-top:10px;}
  th,td{padding:8px;border-bottom:1px solid #eee;}
  th{background:#fafafa;position:sticky;top:0;}
  tr:nth-child(even){background:#fcfcfc;}
  .spinner{width:20px;height:20px;border:3px solid #ccc;border-top-color:#4facfe;border-radius:50%;
           animation:spin 1s linear infinite;display:inline-block;}
  img.thumb{width:60px;height:auto;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.08);}
</style>
</head>
<body>
<header>
  <h1>ðŸ“„ Water Bill OCR</h1>
  <p>Upload photos or take a new one, then extract Meter No. and Consumption.</p>
</header>

<div class="card">
  <label class="btn secondary">
    Upload Photo(s)
    <input type="file" id="fileInput" accept="image/*" multiple hidden>
  </label>
  <label class="btn secondary">
    Take Photo
    <input type="file" id="cameraInput" accept="image/*" capture="environment" hidden>
  </label>
  <button id="clearBtn" class="btn secondary">Clear</button>
  <button id="exportBtn" class="btn primary">Export to Excel</button>
  <div id="status" style="margin-top:10px;color:#555"></div>
</div>

<div class="card">
  <table>
    <thead><tr><th>Preview</th><th>File</th><th>Meter No.</th><th>Consumption</th></tr></thead>
    <tbody id="results"></tbody>
  </table>
</div>

<script>
const fileInput = document.getElementById('fileInput');
const cameraInput = document.getElementById('cameraInput');
const resultsTable = document.getElementById('results');
const statusDiv = document.getElementById('status');
const exportBtn = document.getElementById('exportBtn');
const clearBtn = document.getElementById('clearBtn');
let results = [];

function setStatus(msg, loading=false){
  statusDiv.innerHTML = loading ? msg + ' <span class="spinner"></span>' : msg;
}

function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function resizeImageDataURL(dataURL, maxWidth=1000){
  return new Promise((resolve)=>{
    const img = new Image();
    img.onload = () => {
      const scale = Math.min(1, maxWidth / img.width);
      const canvas = document.createElement('canvas');
      canvas.width = Math.round(img.width * scale);
      canvas.height = Math.round(img.height * scale);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      resolve(canvas.toDataURL('image/jpeg', 0.8));
    };
    img.src = dataURL;
  });
}

function addResultRow(previewDataURL, fileName, meterNo, consumption){
  const tr = document.createElement('tr');
  tr.innerHTML = `<td><img class="thumb" src="${previewDataURL}" alt="preview"></td>
                  <td>${fileName}</td>
                  <td>${meterNo}</td>
                  <td>${consumption}</td>`;
  resultsTable.appendChild(tr);
}

async function processFiles(files){
  for (const file of files){
    const rawDataURL = await fileToDataURL(file);
    const previewDataURL = await resizeImageDataURL(rawDataURL, 600);
    addResultRow(previewDataURL, file.name, "Processing...", "Processing...");

    const { recognize } = Tesseract;
    const res = await recognize(rawDataURL, 'eng', {
      logger: m => { if(m.status === 'recognizing text') setStatus(`Processing ${file.name} â€” ${Math.round(m.progress*100)}%`, true); }
    });
    const text = res.data.text;
    let meter = "Not Found", consumption = "Not Found";

    const meterMatch = text.match(/(?:Meter\s*No\.?\s*[\n\r ]*)([A-Z0-9\-]+)/i) || text.match(/(AJP[^\s]+)/i);
    if(meterMatch) meter = meterMatch[1] || meterMatch[0];

    const consMatch = text.match(/(?:Qty\s*[\n\r ]*)(\d+)/i);
    if(consMatch) consumption = consMatch[1];

    results.push({ fileName: file.name, meterNo: meter, consumption: consumption });

    resultsTable.lastChild.innerHTML = `<td><img class="thumb" src="${previewDataURL}" alt="preview"></td>
                  <td>${file.name}</td>
                  <td>${meter}</td>
                  <td>${consumption}</td>`;
  }
  setStatus("Done");
}

fileInput.addEventListener('change', e => processFiles(e.target.files));
cameraInput.addEventListener('change', e => processFiles(e.target.files));

exportBtn.addEventListener('click', ()=>{
  if(!results.length){ alert('No data to export'); return; }
  const ws = XLSX.utils.json_to_sheet(results.map(r=>({ 'File Name': r.fileName, 'Meter No': r.meterNo, 'Consumption Qty': r.consumption })));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Bills');
  XLSX.writeFile(wb, 'bills.xlsx');
});

clearBtn.addEventListener('click', ()=>{
  fileInput.value = '';
  cameraInput.value = '';
  results = [];
  resultsTable.innerHTML = '';
  setStatus('Cleared', false);
});
</script>
</body>
</html>
