<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Water Bill OCR â€” Hybrid</title>

<!-- Tesseract.js v5 -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
  body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial;
       background:#f2f6fb;margin:0;padding:18px;max-width:480px;margin:auto;}
  header{background:linear-gradient(135deg,#4facfe,#00f2fe);color:white;padding:18px;border-radius:14px;}
  h1{margin:0;font-size:20px;}
  .card{background:white;padding:12px;margin-top:12px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.08);}
  .btn{padding:10px 14px;border:none;border-radius:8px;font-weight:600;font-size:15px;cursor:pointer;}
  .primary{background:#4facfe;color:white;}
  .secondary{background:#f9f9f9;color:#4facfe;border:1px solid #4facfe;}
  table{width:100%;border-collapse:collapse;font-size:14px;margin-top:10px;}
  th,td{padding:8px;border-bottom:1px solid #eee;}
  th{background:#fafafa;position:sticky;top:0;}
  tr:nth-child(even){background:#fcfcfc;}
  .spinner{width:20px;height:20px;border:3px solid #ccc;border-top-color:#4facfe;border-radius:50%;
           animation:spin 1s linear infinite;display:inline-block;}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<header>
  <h1>ðŸ“„ Water Bill OCR</h1>
  <p>Extract Meter No. & Consumption Qty from bill images</p>
</header>

<div class="card">
  <input type="file" id="fileInput" accept="image/*" multiple>
  <button id="clearBtn" class="btn secondary">Clear</button>
  <button id="exportBtn" class="btn primary">Export to Excel</button>
  <div id="status" style="margin-top:10px;color:#555"></div>
</div>

<div class="card">
  <table>
    <thead><tr><th>File</th><th>Meter No.</th><th>Consumption</th></tr></thead>
    <tbody id="results"></tbody>
  </table>
</div>

<script>
const fileInput=document.getElementById('fileInput');
const resultsTable=document.getElementById('results');
const statusDiv=document.getElementById('status');
const exportBtn=document.getElementById('exportBtn');
const clearBtn=document.getElementById('clearBtn');
let results=[];

function setStatus(msg,loading=false){
  statusDiv.innerHTML = loading? msg+' <span class="spinner"></span>' : msg;
}

function resizeImage(file,maxWidth=1000){
  return new Promise(resolve=>{
    const img=new Image();
    const reader=new FileReader();
    reader.onload=e=>{
      img.onload=()=>{
        const scale=Math.min(1,maxWidth/img.width);
        const canvas=document.createElement('canvas');
        canvas.width=img.width*scale;
        canvas.height=img.height*scale;
        const ctx=canvas.getContext('2d');
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        resolve(canvas.toDataURL('image/jpeg',0.8));
      };
      img.src=e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function extractMeterNo(text){
  const patterns=[/Meter\s*No\.?\s*[:\-]?\s*([A-Z0-9\-]+)/i,/([A-Z]{2,3}-\d{1,2}-\d{1,2}-\d{4,})/i];
  for(const p of patterns){const m=text.match(p);if(m)return m[1];}
  return "Not Found";
}
function extractConsumption(text){
  const m=text.match(/Consumption\s*Qty\s*(\d+)/i);if(m)return m[1];
  const nums=text.match(/\b\d{1,4}\b/g);return nums?nums[nums.length-1]:"Not Found";
}

// Detect iOS (Safari/Chrome)
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

fileInput.addEventListener('change',async e=>{
  const files=[...e.target.files];
  results=[];resultsTable.innerHTML="";
  if(!files.length)return;
  setStatus("Starting OCR...",true);

  for(let i=0;i<files.length;i++){
    const file=files[i];
    setStatus(`Processing ${file.name} (${i+1}/${files.length})`,true);
    try{
      const dataURL=await resizeImage(file,1000);

      let text="";
      if(isIOS){
        // Direct mode for iOS (no worker)
        const { recognize } = Tesseract;
        const res=await recognize(dataURL,'eng',{
          logger:m=>{
            if(m.status==='recognizing text'){
              setStatus(`Processing ${file.name} (${i+1}/${files.length}) â€” ${Math.round(m.progress*100)}%`,true);
            }
          }
        });
        text=res.data.text;
      }else{
        // Worker mode for desktop
        const { createWorker } = Tesseract;
        const worker = await createWorker({
          logger: m => {
            if(m.status === 'recognizing text'){
              setStatus(`Processing ${file.name} (${i+1}/${files.length}) â€” ${Math.round(m.progress*100)}%`, true);
            }
          }
        });
        await worker.loadLanguage('eng');
        await worker.initialize('eng');
        await worker.setParameters({
          tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-'
        });
        const {data:{text:txt}}=await worker.recognize(dataURL);
        text=txt;
        await worker.terminate();
      }

      const meter=extractMeterNo(text);
      const cons=extractConsumption(text);

      results.push({fileName:file.name,meterNo:meter,consumption:cons});
      resultsTable.innerHTML+=`<tr><td>${file.name}</td><td>${meter}</td><td>${cons}</td></tr>`;
    }catch(err){
      console.error(err);
      results.push({fileName:file.name,meterNo:"Error",consumption:"Error"});
      resultsTable.innerHTML+=`<tr><td>${file.name}</td><td>Error</td><td>Error</td></tr>`;
    }
  }

  setStatus("Done!");
});

exportBtn.addEventListener('click',()=>{
  if(!results.length){alert("No data to export");return;}
  const ws=XLSX.utils.json_to_sheet(results);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Bills");
  XLSX.writeFile(wb,"bills.xlsx");
});

clearBtn.addEventListener('click',()=>{
  fileInput.value="";
  results=[];
  resultsTable.innerHTML="";
  setStatus("Cleared");
});
</script>
</body>
</html>
