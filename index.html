<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Water Bill OCR ‚Äî Combined</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
  body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial;
       background:#f2f6fb;margin:0;padding:18px;max-width:650px;margin:auto;}
  header{background:linear-gradient(135deg,#4facfe,#00f2fe);color:white;padding:18px;border-radius:14px;}
  h1{margin:0;font-size:20px;}
  .card{background:white;padding:14px;margin-top:16px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.08);}
  .btn{padding:10px 14px;border:none;border-radius:8px;font-weight:600;font-size:15px;cursor:pointer;margin:4px;}
  .primary{background:#4facfe;color:white;}
  .secondary{background:#f9f9f9;color:#4facfe;border:1px solid #4facfe;}
  table{width:100%;border-collapse:collapse;font-size:14px;margin-top:10px;}
  th,td{padding:8px;border-bottom:1px solid #eee;word-break:break-word;text-align:center;}
  th{background:#fafafa;position:sticky;top:0;}
  tr:nth-child(even){background:#fcfcfc;}
  .spinner{width:20px;height:20px;border:3px solid #ccc;border-top-color:#4facfe;border-radius:50%;
           animation:spin 1s linear infinite;display:inline-block;}
  .warn{color:red;font-weight:bold;}
  .diff-red{color:red;font-weight:bold;}
  .diff-green{color:green;font-weight:bold;}
  .diff-gray{color:gray;}
</style>
</head>
<body>
<header>
  <h1>üìÑ Water Bill OCR (With Validation & % Difference)</h1>
  <p>Step 1: Upload past Excel, Step 2: Scan new bills and compare results.</p>
</header>

<div class="card">
  <h2>Step 1: Upload Previous Water Bill Excel</h2>
  <input type="file" id="prevExcel" accept=".xlsx,.xls" />
  <div id="prevStatus" style="margin-top:10px;color:#555"></div>
</div>

<div class="card">
  <h2>Step 2: OCR New Water Bills</h2>
  <label class="btn secondary">
    Upload Photo(s)
    <input type="file" id="fileInput" accept="image/*" multiple hidden>
  </label>
  <label class="btn secondary">
    Take Photo
    <input type="file" id="cameraInput" accept="image/*" capture="environment" hidden>
  </label>
  <button id="clearBtn" class="btn secondary">Clear</button>
  <button id="exportBtn" class="btn primary">Export to Excel</button>
  <div id="status" style="margin-top:10px;color:#555"></div>
  <table>
    <thead><tr>
      <th>Name</th><th>Meter No. (Prev)</th><th>Meter No. (OCR)</th>
      <th>Prev Consumption</th><th>Current Consumption (OCR)</th><th>% Difference</th>
    </tr></thead>
    <tbody id="results"></tbody>
  </table>
</div>

<script>
const prevExcelInput = document.getElementById('prevExcel');
const prevStatus = document.getElementById('prevStatus');
let prevData = [];

prevExcelInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if(!file){ return; }
  const reader = new FileReader();
  reader.onload = (evt)=>{
    const data = new Uint8Array(evt.target.result);
    const workbook = XLSX.read(data, {type:'array'});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet);
    prevData = json;
    prevStatus.innerText = "Loaded " + json.length + " records from previous Excel.";
  };
  reader.readAsArrayBuffer(file);
});

// Step 2 (OCR part)
const fileInput = document.getElementById('fileInput');
const cameraInput = document.getElementById('cameraInput');
const resultsTable = document.getElementById('results');
const statusDiv = document.getElementById('status');
const exportBtn = document.getElementById('exportBtn');
const clearBtn = document.getElementById('clearBtn');
let results = [];

function setStatus(msg, loading=false){
  statusDiv.innerHTML = loading ? msg + ' <span class="spinner"></span>' : msg;
}

function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function calcDiff(prev, curr){
  if(!prev || isNaN(prev) || prev == 0 || !curr || isNaN(curr)) return {text:"‚Äî", cls:"diff-gray"};
  const diff = ((curr - prev)/prev)*100;
  const rounded = diff.toFixed(1) + "%";
  if(diff > 30){ return {text: rounded, cls:"diff-red"}; }
  else{ return {text: rounded, cls:"diff-green"}; }
}

async function processFiles(files){
  for (const file of files){
    const rawDataURL = await fileToDataURL(file);
    setStatus("Processing " + file.name, true);

    const { recognize } = Tesseract;
    const res = await recognize(rawDataURL, 'eng');
    const text = res.data.text;
    let meterOCR = "Not Found", consumptionOCR = "Not Found";

    const meterMatch = text.match(/(?:Meter\s*No\.?\s*[\n\r ]*)([A-Z0-9\-]+)/i) || text.match(/(AJP[^\s]+)/i);
    if(meterMatch) meterOCR = meterMatch[1] || meterMatch[0];

    const consMatch = text.match(/(?:Qty\s*[\n\r ]*)(\d+)/i);
    if(consMatch) consumptionOCR = consMatch[1];

    // Validation against Step 1
    let name = "‚ö†Ô∏è Not Found";
    let meterPrev = "‚ö†Ô∏è Not Found";
    let prevCons = "‚ö†Ô∏è Not Found";
    if(prevData.length > 0){
      const found = prevData.find(r => (r["Meter No."] || "").toString().trim() === meterOCR.trim());
      if(found){
        name = found.Name || "";
        meterPrev = found["Meter No."] || "";
        prevCons = found.Consumption || "";
      }
    }

    const prevNum = parseFloat(prevCons);
    const currNum = parseFloat(consumptionOCR);
    const diffObj = calcDiff(prevNum, currNum);

    const row = { name, meterPrev, meterOCR, prevCons, consumptionOCR, diff: diffObj.text };
    results.push(row);

    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${name.includes("‚ö†Ô∏è") ? "<span class='warn'>"+name+"</span>" : name}</td>
                    <td>${meterPrev.includes("‚ö†Ô∏è") ? "<span class='warn'>"+meterPrev+"</span>" : meterPrev}</td>
                    <td>${meterOCR}</td>
                    <td>${prevCons.includes("‚ö†Ô∏è") ? "<span class='warn'>"+prevCons+"</span>" : prevCons}</td>
                    <td>${consumptionOCR}</td>
                    <td class='${diffObj.cls}'>${diffObj.text}</td>`;
    resultsTable.appendChild(tr);
  }
  setStatus("Done");
}

fileInput.addEventListener('change', e => processFiles(e.target.files));
cameraInput.addEventListener('change', e => processFiles(e.target.files));

exportBtn.addEventListener('click', ()=>{
  if(!results.length){ alert('No data to export'); return; }
  const exportData = results.map(r=>({ Name: r.name, "Meter No.": r.meterPrev, "Current Consumption": r.consumptionOCR }));
  const ws = XLSX.utils.json_to_sheet(exportData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Results');
  XLSX.writeFile(wb, 'bills_results.xlsx');
});

clearBtn.addEventListener('click', ()=>{
  fileInput.value = '';
  cameraInput.value = '';
  results = [];
  resultsTable.innerHTML = '';
  setStatus('Cleared', false);
});
</script>
</body>
</html>
